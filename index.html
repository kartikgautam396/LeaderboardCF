<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udai Codeforces Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .rating-newbie { color: #808080; }
        .rating-pupil { color: #008000; }
        .rating-specialist { color: #03A89E; }
        .rating-expert { color: #0000FF; }
        .rating-candidate-master { color: #AA00AA; }
        .rating-master { color: #FF8C00; }
        .rating-international-master { color: #FF8C00; }
        .rating-grandmaster { color: #FF0000; }
        .rating-international-grandmaster { color: #FF0000; }
        .rating-legendary-grandmaster { color: #FF0000; }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-active { background-color: #3B82F6; color: white; }
        .tab-inactive { background-color: #F3F4F6; color: #6B7280; }
        .subtab-active { background-color: #10B981; color: white; }
        .subtab-inactive { background-color: #E5E7EB; color: #6B7280; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="relative text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üèÜ Codeforces Multi-Leaderboard</h1>
            <p class="text-gray-600">Live data fetched from Google Sheets & Codeforces API</p>
        </div>

        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="flex flex-wrap border-b border-gray-200">
                <button onclick="switchMainTab('udaigiri')" id="maintab-udaigiri" class="px-6 py-3 font-medium rounded-tl-lg tab-active transition-colors duration-200">üèîÔ∏è Udaigiri (All)</button>
                <button onclick="switchMainTab('year2022')" id="maintab-year2022" class="px-6 py-3 font-medium tab-inactive transition-colors duration-200">üìÖ 2022 Entry</button>
                <button onclick="switchMainTab('year2023')" id="maintab-year2023" class="px-6 py-3 font-medium tab-inactive transition-colors duration-200">üìÖ 2023 Entry</button>
                <button onclick="switchMainTab('year2024')" id="maintab-year2024" class="px-6 py-3 font-medium tab-inactive transition-colors duration-200">üìÖ 2024 Entry</button>
                <button onclick="switchMainTab('year2025')" id="maintab-year2025" class="px-6 py-3 font-medium tab-inactive transition-colors duration-200">üìÖ 2025 Entry</button>
                <button onclick="switchMainTab('daily')" id="maintab-daily" class="px-6 py-3 font-medium tab-inactive transition-colors duration-200">üìä Daily</button>
            </div>
        </div>

        <div id="subTabContainer" class="bg-white rounded-lg shadow-lg mb-6">
            <div class="flex flex-wrap border-b border-gray-200 bg-gray-50">
                <button onclick="switchSubTab('rating')" id="subtab-rating" class="px-4 py-2 text-sm font-medium subtab-active transition-colors duration-200">üìà Rating Board</button>
                <button onclick="switchSubTab('contest1')" id="subtab-contest1" class="px-4 py-2 text-sm font-medium subtab-inactive transition-colors duration-200">üèÜ Latest Contest</button>
                <button onclick="switchSubTab('contest2')" id="subtab-contest2" class="px-4 py-2 text-sm font-medium subtab-inactive transition-colors duration-200">üèÜ Contest -1</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800" id="leaderboardTitle">Udaigiri Leaderboard</h2>
            <div class="flex gap-3">
                <button onclick="fullSystemReload()" id="refreshBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 disabled:bg-gray-400">
                    <span>üîÑ</span> Refresh Data
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div id="loadingOverlay" class="hidden p-12 text-center text-gray-500">
                <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
                <p>Fetching data from Google Sheets & Codeforces...</p>
            </div>
            <div id="leaderboard" class="divide-y divide-gray-200 min-h-[200px]">
                </div>
        </div>

        <div id="statusMessage" class="mt-4 text-center"></div>
        
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6 text-center">
            <p class="text-gray-700 font-medium mb-1">Not on the leaderboard?</p>

            <p className="text-gray-600">
             DM <span class="font-semibold text-blue-600">Kartik Sharma</span> on WhatsApp: 
                <a href="https://wa.me/919306427609" target="_blank" class="text-green-600 hover:text-green-700 font-semibold underline transition-colors duration-200">
                    +91 9306427609
                </a>
                <br>
            <span class="font-semibold text-blue-600">Yashdeep Singh</span> on WhatsApp: 
                <a href="https://wa.me/919999766658" target="_blank" class="text-green-600 hover:text-green-700 font-semibold underline transition-colors duration-200">
                    +91 9999766658
                </a>
          </p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THIS LINK with your Google Sheet "Published to Web" CSV link
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNDOFinnoRvzcTfsXJPZzhBmtXs2E1HvM7pe0LpVEN9-LznZa0GdccVlCBt-znhWVtj54I9LArKkww/pub?output=csv"; 
        
        // Data Structure
        let leaderboards = {
            udaigiri: [], year2022: [], year2023: [], year2024: [], year2025: [], daily: []
        };
        
        let contestData = JSON.parse(localStorage.getItem('contestData') || '{}');
        let recentContests = JSON.parse(localStorage.getItem('recentContests') || '[]');
        
        let currentMainTab = 'udaigiri';
        let currentSubTab = 'rating';

        const leaderboardTitles = {
            udaigiri: 'Udaigiri (All)', year2022: '2022 Entry', year2023: '2023 Entry', 
            year2024: '2024 Entry', year2025: '2025 Entry', daily: 'Daily Problems'
        };

        // --- CORE FUNCTIONS ---

        // 1. Fetch Users from Google Sheet (MODIFIED LOGIC)
        async function fetchSheetData() {
            try {
                // Reset leaderboards
                Object.keys(leaderboards).forEach(k => leaderboards[k] = []);
                
                const response = await fetch(SHEET_CSV_URL);
                const text = await response.text();
                
                // Parse CSV (Assumes Row 1 is header, Col 0 is Handle, Col 1 is Category)
                const rows = text.split('\n').map(row => row.split(','));
                
                const allHandles = new Set();
                const processedForUdaigiri = new Set(); // To prevent duplicates in master list

                // Start from index 1 to skip header
                for (let i = 1; i < rows.length; i++) {
                    const handle = rows[i][0]?.trim();
                    const category = rows[i][1]?.trim().toLowerCase();
                    
                    if (handle) {
                        // Create basic user object
                        const userObj = { 
                            username: handle, 
                            rating: 0, 
                            maxRating: 0, 
                            rank: 'unrated', 
                            avatar: '' 
                        };

                        // 1. Add to the specific category from the sheet (e.g., year2024)
                        if (category && leaderboards[category]) {
                            leaderboards[category].push({ ...userObj }); // Push a copy
                        }

                        // 2. AUTOMATICALLY add to 'udaigiri' (Master List)
                        if (!processedForUdaigiri.has(handle.toLowerCase())) {
                            leaderboards['udaigiri'].push({ ...userObj }); // Push a copy
                            processedForUdaigiri.add(handle.toLowerCase());
                        }

                        allHandles.add(handle);
                    }
                }
                return Array.from(allHandles);
            } catch (error) {
                showStatus("Failed to load Google Sheet. Check URL.", "error");
                console.error(error);
                return [];
            }
        }

        // 2. Batch Fetch User Info from Codeforces (Efficient)
        async function updateCodeforcesData(handles) {
            if (handles.length === 0) return;

            const chunkSize = 100; 
            
            for (let i = 0; i < handles.length; i += chunkSize) {
                const chunk = handles.slice(i, i + chunkSize);
                const handleString = chunk.join(';');
                const apiUrl = `https://codeforces.com/api/user.info?handles=${handleString}`;

                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.status === 'OK') {
                        data.result.forEach(cfUser => {
                            // Update this user in EVERY list they appear in (Udaigiri + Year)
                            Object.keys(leaderboards).forEach(key => {
                                const userIndex = leaderboards[key].findIndex(u => u.username.toLowerCase() === cfUser.handle.toLowerCase());
                                if (userIndex !== -1) {
                                    leaderboards[key][userIndex] = {
                                        ...leaderboards[key][userIndex],
                                        rating: cfUser.rating || 0,
                                        maxRating: cfUser.maxRating || 0,
                                        rank: cfUser.rank || 'unrated',
                                        maxRank: cfUser.maxRank || 'unrated',
                                        avatar: cfUser.titlePhoto || cfUser.avatar, 
                                        lastOnline: cfUser.lastOnlineTimeSeconds
                                    };
                                }
                            });
                        });
                    }
                } catch (e) {
                    console.error("Error fetching batch data", e);
                }
            }
        }

        // 3. Master Reload Function
        async function fullSystemReload() {
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const leaderboardDiv = document.getElementById('leaderboard');
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<div class="loading-spinner"></div> Loading...';
            leaderboardDiv.innerHTML = '';
            loadingOverlay.classList.remove('hidden');

            try {
                showStatus("Fetching list from Sheet...", "info");
                const handles = await fetchSheetData();
                
                showStatus(`Found ${handles.length} users. Fetching Codeforces data...`, "info");
                await updateCodeforcesData(handles);
                
                initializeDailyLeaderboard();
                await fetchRecentContests();
                
                showStatus("Data updated successfully!", "success");
            } catch (e) {
                showStatus("Error updating data", "error");
            } finally {
                loadingOverlay.classList.add('hidden');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<span>üîÑ</span> Refresh Data';
                updateTitles();
                renderLeaderboard();
            }
        }

        // --- HELPER FUNCTIONS ---

        function getRatingColor(rating) {
            if (rating < 1200) return 'rating-newbie';
            if (rating < 1400) return 'rating-pupil';
            if (rating < 1600) return 'rating-specialist';
            if (rating < 1900) return 'rating-expert';
            if (rating < 2100) return 'rating-candidate-master';
            if (rating < 2300) return 'rating-master';
            if (rating < 2400) return 'rating-international-master';
            if (rating < 2600) return 'rating-grandmaster';
            if (rating < 3000) return 'rating-international-grandmaster';
            return 'rating-legendary-grandmaster';
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const colors = { success: 'text-green-600', error: 'text-red-600', info: 'text-blue-600' };
            statusDiv.innerHTML = `<p class="${colors[type]} font-medium">${message}</p>`;
            setTimeout(() => statusDiv.innerHTML = '', 4000);
        }

        function switchMainTab(tabName) {
            document.querySelectorAll('[id^="maintab-"]').forEach(tab => 
                tab.className = tab.className.replace('tab-active', 'tab-inactive'));
            document.getElementById(`maintab-${tabName}`).className = 
                document.getElementById(`maintab-${tabName}`).className.replace('tab-inactive', 'tab-active');
            
            currentMainTab = tabName;
            currentSubTab = 'rating'; 
            
            const subTabContainer = document.getElementById('subTabContainer');
            if (tabName === 'daily') {
                subTabContainer.style.display = 'none';
            } else {
                subTabContainer.style.display = 'block';
                switchSubTab('rating'); 
            }
            updateTitles();
            renderLeaderboard();
        }

        function switchSubTab(subTabName) {
            document.querySelectorAll('[id^="subtab-"]').forEach(tab => 
                tab.className = tab.className.replace('subtab-active', 'subtab-inactive'));
            document.getElementById(`subtab-${subTabName}`).className = 
                document.getElementById(`subtab-${subTabName}`).className.replace('subtab-inactive', 'subtab-active');
            
            currentSubTab = subTabName;
            
            if (subTabName.startsWith('contest')) {
                fetchContestStandingsIfNeeded();
            }
            
            updateTitles();
            renderLeaderboard();
        }

        function updateTitles() {
            const mainTitle = leaderboardTitles[currentMainTab];
            let subTitle = '';
            
            if (currentMainTab !== 'daily') {
                if (currentSubTab === 'rating') {
                    subTitle = 'Rating Board';
                } else {
                    const contestIndex = parseInt(currentSubTab.replace('contest', '')) - 1;
                    if (recentContests[contestIndex]) {
                        subTitle = `Contest: ${recentContests[contestIndex].name}`;
                    } else {
                        subTitle = `Contest ${currentSubTab.replace('contest', '')}`;
                    }
                }
            } else {
                subTitle = 'Leaderboard';
            }
            document.getElementById('leaderboardTitle').textContent = `${mainTitle} ${subTitle}`;
        }

        function initializeDailyLeaderboard() {
            const allUsers = new Map();
            Object.keys(leaderboards).forEach(boardName => {
                leaderboards[boardName].forEach(user => {
                    if (!allUsers.has(user.username.toLowerCase())) {
                        allUsers.set(user.username.toLowerCase(), { ...user, dailyProblems: 0 });
                    }
                });
            });
            leaderboards.daily = Array.from(allUsers.values());
        }

        async function fetchRecentContests() {
            try {
                const response = await fetch('https://codeforces.com/api/contest.list?gym=false');
                const data = await response.json();
                if (data.status === 'OK') {
                    const finished = data.result
                        .filter(c => c.phase === 'FINISHED')
                        .sort((a, b) => b.startTimeSeconds - a.startTimeSeconds)
                        .slice(0, 3);
                    
                    recentContests = finished.map(c => ({ id: c.id, name: c.name }));
                    localStorage.setItem('recentContests', JSON.stringify(recentContests));
                }
            } catch (e) { console.error("Contest list fetch failed", e); }
        }

        async function fetchContestStandingsIfNeeded() {
            const contestIndex = parseInt(currentSubTab.replace('contest', '')) - 1;
            if (!recentContests[contestIndex]) return;

            const contestId = recentContests[contestIndex].id;
            const users = leaderboards[currentMainTab];
            const usersToFetch = users.map(u => u.username).join(';');
            
            const apiUrl = `https://codeforces.com/api/contest.standings?contestId=${contestId}&handles=${usersToFetch}&showUnofficial=false`;
            
            try {
                showStatus("Loading contest standings...", "info");
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    data.result.rows.forEach(row => {
                        const handle = row.party.members[0].handle;
                        const rank = row.rank;
                        const oldRating = row.party.members[0].oldRating || 0; 
                        const newRating = row.party.members[0].newRating || 0;
                        const change = newRating - oldRating; 

                        if (!contestData[handle]) contestData[handle] = {};
                        contestData[handle][contestId] = { rank, ratingChange: change, participated: true };
                    });
                    
                    users.forEach(u => {
                        if (!contestData[u.username]) contestData[u.username] = {};
                        if (!contestData[u.username][contestId]) {
                             contestData[u.username][contestId] = { participated: false };
                        }
                    });
                    
                    renderLeaderboard();
                    showStatus("Contest data loaded", "success");
                }
            } catch (e) { console.error(e); }
        }

        function renderLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            let users = leaderboards[currentMainTab] || [];
            
            if (users.length === 0) {
                leaderboard.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <div class="text-4xl mb-4">üìÑ</div>
                        <p>No data found. Check Google Sheet link or click Refresh.</p>
                    </div>`;
                return;
            }

            let sortedUsers = [...users];
            if (currentSubTab === 'rating') {
                sortedUsers.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (currentSubTab.startsWith('contest')) {
                const contestIndex = parseInt(currentSubTab.replace('contest', '')) - 1;
                if (recentContests[contestIndex]) {
                    const cid = recentContests[contestIndex].id;
                    sortedUsers.sort((a, b) => {
                        const rA = contestData[a.username]?.[cid]?.rank || 99999;
                        const rB = contestData[b.username]?.[cid]?.rank || 99999;
                        return rA - rB;
                    });
                }
            }

            leaderboard.innerHTML = sortedUsers.map((user, index) => {
                let rightSideContent = '';
                
                if (currentSubTab === 'rating') {
                    rightSideContent = `
                        <div class="font-bold text-lg ${getRatingColor(user.rating)}">${user.rating}</div>
                        <div class="text-xs text-gray-500">Max: ${user.maxRating}</div>
                    `;
                } else if (currentSubTab.startsWith('contest')) {
                    const contestIndex = parseInt(currentSubTab.replace('contest', '')) - 1;
                    if (recentContests[contestIndex]) {
                        const cid = recentContests[contestIndex].id;
                        const cData = contestData[user.username]?.[cid];
                        
                        if (cData && cData.participated) {
                            // CHANGE MADE HERE: Format changed to "Rank XXX"
                            rightSideContent = `
                                <div class="font-bold text-lg text-blue-600">Rank ${cData.rank}</div>
                            `;
                        } else {
                            rightSideContent = `<div class="text-gray-400 text-sm">Absent</div>`;
                        }
                    }
                }

                const avatarUrl = user.avatar || "https://userpic.codeforces.org/no-avatar.jpg";
                
                return `
                    <div class="p-4 hover:bg-gray-50 transition-colors duration-200 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="text-xl font-bold text-gray-400 w-8 text-center">${index + 1}</div>
                            <img src="${avatarUrl}" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                            <div>
                                <a href="https://codeforces.com/profile/${user.username}" target="_blank" class="font-semibold ${getRatingColor(user.rating)} hover:underline">
                                    ${user.username}
                                </a>
                                <div class="text-xs text-gray-500 capitalize">${user.rank}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            ${rightSideContent}
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', function() {
            fullSystemReload();
        });

    </script>
</body>
</html>
